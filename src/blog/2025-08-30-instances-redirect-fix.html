<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">
<head>
    <title>Fixing "Moved Permanently" on MCP instance endpoints - MCP as a Service Blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Some MCP instance HTTP endpoints returned 'Moved Permanently' because Traefik redirected an http ForwardAuth address generated by Symfony. We explain what happened and how it was fixed.">

    <!-- Standard SEO Meta Tags -->
    <meta name="author" content="Manuel Kießling">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="Symfony, Traefik, Reverse Proxy, X-Forwarded, Trusted Proxies, MCP">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://mcp-as-a-service.com/blog/2025-08-30-instances-redirect-fix.html">
    <meta property="og:title" content="Fixing 'Moved Permanently' on MCP instance endpoints">
    <meta property="og:description" content="Root cause: Symfony generated an http ForwardAuth address for Traefik due to incomplete trusted headers; Traefik then redirected (301) to https. We updated trusted headers and proxy settings to generate https.">
    <meta property="og:image" content="https://mcp-as-a-service.com/images/mcp-improvements-preview.jpg">
    <meta property="og:site_name" content="MCP as a Service">
    <meta property="og:locale" content="en_US">
    <meta property="article:published_time" content="2025-08-30T00:00:00+00:00">
    <meta property="article:author" content="Manuel Kießling">
    <meta property="article:section" content="Operations">
    <meta property="article:tag" content="Symfony">
    <meta property="article:tag" content="Traefik">
    <meta property="article:tag" content="Reverse Proxy">
    <meta property="article:tag" content="Trusted Proxies">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@dx_tooling">
    <meta name="twitter:creator" content="@manuelkiessling">
    <meta name="twitter:title" content="Fixing 'Moved Permanently' on MCP instance endpoints">
    <meta name="twitter:description" content="Traefik redirected because ForwardAuth address was http (from Symfony). Fix: configure full trusted headers/proxies so https URLs are generated.">
    <meta name="twitter:image" content="https://mcp-as-a-service.com/images/mcp-improvements-preview.jpg">

    <!-- Blog System Metadata (for our internal system) -->
    <meta name="blog:readTime" content="4 min read">

    <!-- Include FOUC guard script -->
    <include src="partials/theme-fouc-guard.html"></include>

    <!-- Link to CSS will be injected here by HtmlWebpackPlugin -->
</head>

<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200 overflow-x-hidden">

<include src="partials/nav.html"></include>

<div class="container mx-auto px-4 py-12 max-w-4xl">
    <!-- Blog Header -->
    <header class="mb-8">
        <nav class="mb-6">
            <a href="../index.html" class="text-blue-600 dark:text-blue-400 hover:underline">← Back to Home</a>
        </nav>

        <div class="mb-6">
            <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 mb-3">
                <time datetime="2025-08-30">August 30, 2025</time>
                <span>•</span>
                <span>4 min read</span>
                <span>•</span>
                <span>Manuel Kießling</span>
            </div>
            <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">Symfony</span>
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">Traefik</span>
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">Reverse Proxy</span>
                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded">Trusted Proxies</span>
            </div>
        </div>

        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-6 leading-tight">
            Fixing "Moved Permanently" on MCP instance endpoints
        </h1>

        <p class="text-xl text-gray-600 dark:text-gray-300 leading-relaxed">
            A small configuration gap between our app and the reverse proxy caused certain instance HTTP endpoints to reply with "Moved Permanently" (HTTP 301). This post explains what happened and how we fixed it.
        </p>
    </header>

    <!-- Blog Content -->
    <article class="prose prose-lg dark:prose-invert max-w-none">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-8 mb-4">The short version</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            Some links to MCP instance endpoints unexpectedly redirected. The root cause: Symfony generated an <em>http</em> URL for our authentication callback (ForwardAuth) that Traefik uses to validate tokens. Traefik then redirected that address to <em>https</em> (301). We updated our settings so Symfony trusts the proxy and generates the correct <em>https</em> URL. After the change, those endpoints respond normally again—no more surprise redirects.
        </p>

        <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg mb-6">
            <p class="text-blue-900 dark:text-blue-100 mb-2"><strong>What changed?</strong></p>
            <ul class="list-disc list-inside space-y-2 text-blue-800 dark:text-blue-200">
                <li>We told Symfony exactly which proxy to trust.</li>
                <li>We listed all standard <code>X-Forwarded-*</code> headers it should honor.</li>
                <li>We added a short troubleshooting note to our runbook.</li>
            </ul>
        </div>

        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-8 mb-4">The technical details</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">
            The webapp runs behind Traefik. Symfony needs to trust the proxy and consume <code>X-Forwarded-*</code> headers to reconstruct the original request's scheme, host, and port. With incomplete trusted header configuration, Symfony produced an <code>http</code> URL when composing the ForwardAuth address used in the Traefik label <code>traefik.http.middlewares.mcp-&lt;slug&gt;-auth.forwardauth.address</code>. Traefik subsequently redirected that address to <code>https</code> with a 301.
        </p>

        <p class="text-gray-700 dark:text-gray-300 mb-6">
            We fixed this by:
        </p>
        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 mb-6">
            <li>Declaring the proxy via <code>TRUSTED_PROXIES=REMOTE_ADDR</code> so Symfony trusts the immediate reverse proxy.</li>
            <li>Expanding <code>framework.trusted_headers</code> to include<br><code>x-forwarded-for</code>, <code>x-forwarded-host</code>, <code>x-forwarded-proto</code>, <code>x-forwarded-port</code>, and <code>x-forwarded-prefix</code>.</li>
        </ul>

        <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto text-sm mb-6"><code># .env.prod.local.dist
TRUSTED_PROXIES=REMOTE_ADDR

# config/packages/framework.yaml (excerpt)
framework:
  trusted_proxies: '%env(TRUSTED_PROXIES)%'
  trusted_headers: ['x-forwarded-for', 'x-forwarded-host', 'x-forwarded-proto', 'x-forwarded-port', 'x-forwarded-prefix']</code></pre>

        <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto text-sm mb-6"><code># Traefik label (before → after)
traefik.http.middlewares.mcp-&lt;slug&gt;-auth.forwardauth.address=http://app.mcp-as-a-service.com/auth/mcp-bearer-check
# becomes
traefik.http.middlewares.mcp-&lt;slug&gt;-auth.forwardauth.address=https://app.mcp-as-a-service.com/auth/mcp-bearer-check</code></pre>

        <p class="text-gray-700 dark:text-gray-300 mb-6">
            For operational visibility, we also added a small runbook snippet to quickly inspect Traefik-discovered labels on an instance container when debugging routing:
        </p>
        <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto text-sm"><code>docker inspect mcp-instance-&lt;slug&gt; | jq -r '.\[0\].Config.Labels
| to_entries[]
| select(.key|startswith("traefik.http."))
| "\(.key)=\(.value)"'</code></pre>

        <p class="text-gray-700 dark:text-gray-300 mb-6">
            References:
            <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://github.com/dx-tooling/maas-webapp/issues/4" target="_blank">Issue #4</a>,
            <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://github.com/dx-tooling/maas-webapp/pull/5/files" target="_blank">PR #5</a>, and
            <a class="text-blue-600 dark:text-blue-400 hover:underline" href="https://github.com/dx-tooling/maas-webapp/blob/main/docs/orchestration.md" target="_blank">orchestration docs</a>.
        </p>
    </article>

    <!-- Blog Footer -->
    <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
            <a href="../index.html" class="text-blue-600 dark:text-blue-400 hover:underline">← Back to Home</a>
        </div>
    </footer>
</div>

<!-- The script tag will be injected by HtmlWebpackPlugin -->
</body>
</html>


